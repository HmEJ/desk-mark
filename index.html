<canvas id="canvas"></canvas>

<style>
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden !important; /* ðŸ”¥ å…³é”® */
        background: transparent;
    }

    canvas {
        display: block; /* ðŸ”¥ é˜²æ­¢ inline å…ƒç´ å¤š 2px */
    }
</style>


<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let config = {
        text: 'CONFIDENTIAL',
        angle: -45,
        fontSize: 32,
        gap: 200,
        opacity: 0.15,
        color: '#000',
        fontFamily: 'Alibaba'
    };

    function resize() {
        canvas.width = innerWidth;
        canvas.height = innerHeight;
    }

    resize();
    addEventListener('resize', resize);

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.globalAlpha = config.opacity;
        ctx.fillStyle = config.color;
        ctx.font = `${config.fontSize}px ${config.fontFamily}`;
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(config.angle * Math.PI / 180);

        const text = resolveTemplate(config.text);
        const w = ctx.measureText(text).width;

        const stepX = w + config.gap;
        const stepY = config.fontSize + config.gap;

        for (let x = -canvas.width; x < canvas.width; x += stepX) {
            for (let y = -canvas.height; y < canvas.height; y += stepY) {
                const text = resolveTemplate(config.text);
                ctx.fillText(text, x, y);

            }
        }
        ctx.restore();
    }

    function resolveTemplate(template) {
        const now = new Date();

        const pad = n => n.toString().padStart(2, '0');

        const vars = {
            time: `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} `
                + `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`,
            date: `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`,
            username: window.runtime?.username || 'Unknown',
            hostname: window.runtime?.hostname || 'PC'
        };

        return template.replace(/\$\{(\w+)\}/g, (_, key) => vars[key] ?? '');
    }


    window.api.onConfig(cfg => {
        Object.assign(config, cfg);
        draw();
    });
    window.api.onReload(() => {
        location.reload();
    });

</script>
